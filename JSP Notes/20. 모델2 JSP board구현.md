모델 2 (MVC) JSP board 구현 2
===========================

## 1. 목록보기

### 1) DB

* 테이블 생성

![alt](/assets/images/post/jsp/138.png)

```sql
DROP TABLE mvcboard	CASCADE CONSTRAINTS;
CREATE TABLE mvcboard (
	idx	NUMBER PRIMARY KEY,
	name varchar2(50) NOT NULL,
	title varchar2(200) NOT NULL,
	content varchar2(2000) NOT NULL,
	postdate DATE DEFAULT sysdate NOT NULL,
	ofile varchar2(200),
	sfile varchar2(30),
	download NUMBER DEFAULT 0 NOT NULL,
	pass varchar2(50) NOT NULL,
	visitcount NUMBER DEFAULT 0 NOT null
);
```
* 시퀀스 객체 생성

```sql
-- 일련번호형 시퀀스(Sequence) 객체 생성
-- : 순차적으로 증가하는 순번을 반환하는 데이터베이스 객체임.
DROP SEQUENCE seq_board_num;
CREATE SEQUENCE seq_board_num
	INCREMENT BY 1				-- 1씩 증가
	START WITH 1				-- 시작값 1
	MINVALUE 1					-- 최소값 1
	nomaxvalue					-- 최대값은 무한대
	nocycle						-- 순환하지 않음
	nocache						-- 캐시 안함
	;
```

![alt](/assets/images/post/jsp/139.png)

* test 주입

```sql
INSERT INTO EZEN.MVCBOARD
(IDX, NAME, TITLE, CONTENT, PASS)
VALUES(seq_board_num.nextval, 'bob', 'bob의 개발일기', 
                '자바와 스프링을 공부하고있습니다.', '0824' );
```

![alt](/assets/images/post/jsp/140.png)

### 2) class 생성

* (통합) JDBConnection.java

```java
package kr.co.ezenac.model2common;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import javax.servlet.ServletContext;

public class JDBConnection {
	public Connection conn;
	public Statement stmt;
	public PreparedStatement psmt;
	public ResultSet rs;
	
	
		public JDBConnection(String driver, String url,String id, String pwd) {
			try {
				Class.forName(driver);
				conn = DriverManager.getConnection(url,id,pwd);
			} catch (ClassNotFoundException | SQLException e) {
				
				e.printStackTrace();
			}
		}
	public JDBConnection(ServletContext application) {
		// JDBC 드라이버 로드
		String driver = application.getInitParameter("OracleDriver");
		try {
			Class.forName(driver);

			// DB연결
			String url = application.getInitParameter("OracleURL");
			String id = application.getInitParameter("OracleId");
			String pwd = application.getInitParameter("OraclePw");
			conn = DriverManager.getConnection(url,id,pwd);
			System.out.println("db 연결 성공! - 매개변수 application");
		} catch (ClassNotFoundException | SQLException e) {
			e.printStackTrace();
		}
	}

	public void close() {
		try {
			if (rs != null)
				rs.close();
			if (stmt !=null)
				stmt.close();
			if (psmt != null)
				psmt.close();
			if (conn != null)
				conn.close();

		} catch (SQLException e) {
			e.printStackTrace();
		}
	}
}

```

* 커넥션 풀 활용 context.xml

```xml
<!--
       name : 생성할 자원(풀) 이름 
       auth : 인증 주체
    	 type : 데이터 소스로 사용할 클래스 명 
    	 driverClassName : JDBC 드라이버의 클래스명
    	 url : 접속할 데이터베이스 주소와 포트 번호 및 SID
       maxActive : 동시에 최대로 DB에 연결할 수 있는 Connection
       maxWait : 새로운 연결이 생길 때까지 기다릴 수 있는 최대 시간
   	-->
     <Resource 
    	name="jdbc/oracle" 
    	auth="Conainer" 
    	type="javax.sql.DataSource" 
    	driverClassName="oracle.jdbc.driver.OracleDriver"
    	url="jdbc:oracle:thin:@localhost:1521:XE"
    	username="ezen"
    	password="0824"
    	maxTotal="50"
    	maxWaitMillis="-1"
    />  
```

* BoardDTO.java

```java
package kr.co.ezenac.model2.board;

import java.sql.Date;

public class BoardDTO {
	private String idx;
	private String name;
	private String content;
	private Date postdate;
	private String ofile;
	private String sfile;
	private int download;
	private String pass;
	private int visitcount;
	public String getIdx() {
		return idx;
	}
    // setter 생성
    //getter 생성
}
```

* BoardDAO.java
```java
package kr.co.ezenac.model2.board;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import javax.servlet.ServletContext;

import kr.co.ezenac.model2common.JDBConnection;



public class BoardDAO extends JDBConnection {// DB 연결을 위한 클래스 상속
	
	public BoardDAO(ServletContext application) {	
		super(application);							
	}
	
	// (검색 조건에 맞게) 보드 테이블에 저장된 게시물의 개수 반환
	// 목록에서 번호를 출력
	public int selectCount(Map<String, Object> map) {
		int totalCount = 0;	// 결과(게시물 수)를 담는 변수
		
		// 게시물 수를 얻어오는 쿼리문
		// Map 컬렉션에 저장된 값(검색어)이 있는 경우 Map 컬렉션에 키로 저장된 
		//값이 있을때만 where절을 추가
		String query = "SELECT count(*) FROM mvcboard ";
		if(map.get("searchWord") !=null) {
			query += "WHERE "+map.get("searchField")+" "+" LIKE '%"
											+map.get("searchWord")+"%'";
		}
		
		 try {
			stmt = conn.createStatement();		
			// 쿼리문 실행하기 위해 Statement 객체 생성
			rs = stmt.executeQuery(query);		
			// SELECT 쿼리문 실행. 실행 결과는 Result객체에 담음
			rs.next();							
			// 커서를 첫번째 행으로 이동
			totalCount = rs.getInt(1);			
			// ResultSet객체의 1번(첫번째) 인덱스의 결과를 정수로 가져옴
		} catch (SQLException e) {
			e.printStackTrace();
		}
		
		
		return totalCount;
	}
	
	// board 테이블의 레코드를 가죠와서 반환함.
	// 이 메서드가 반환한 resultSet 객체로부터 게시물 목록을 반복하여 출력 (paging 기능)
	public List<BoardDTO> selectListPage(Map<String, Object> map){
		List<BoardDTO> board = new ArrayList<>(); // 게시물 목록(결과)을 담을 변수
		
		String query = "SELECT * FROM ( "+
					   "SELECT tb.*, ROWNUM rnum FROM ( "+
					   "SELECT * FROM MVCBOARD";
		if(map.get("searchWord") !=null) {	
			// Map컬렉션에 값이 있을때만 검색을 위한 where절 추가
			query += "WHERE "+map.get("searchField")+" "+" LIKE '%"
											+map.get("searchWord")+"%'";
		}
		query += " ORDER BY num DESC"
				+ ") tb"
				+ ")"
				+ "where rNum BETWEEN ? AND ?";
		try {
			psmt = conn.prepareStatement(query);
			psmt.setString(1, map.get("start").toString());
			psmt.setString(1,map.get("end").toString());
			rs = psmt.executeQuery();
			
			while(rs.next()) {
				BoardDTO dto = new BoardDTO();
				
				dto.setIdx(rs.getString(1));
				dto.setName(rs.getString(2));
				dto.setTitle(rs.getString(3));
				dto.setContent(rs.getString(4));
				dto.setPostdate(rs.getDate(5));
				dto.setOfile(rs.getString(6));
				dto.setSfile(rs.getString(7));
				dto.setDownload(rs.getInt(8));
				dto.setPass(rs.getString(9));
				dto.setVisitcount(rs.getInt(10));
				
				board.add(dto);
				
			}
			
		} catch (SQLException e) {
			System.out.println("게시물 조회 중 예외 발생");
			e.printStackTrace();
			
		}
		
		return board;
	}
	
	
}
```




























